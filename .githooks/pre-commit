#!/usr/bin/env bash
set -euo pipefail

python - <<'PY'
import fnmatch
import json
import os
import subprocess
import sys

root = subprocess.check_output(["git", "rev-parse", "--show-toplevel"], text=True).strip()
staged = subprocess.check_output(
    ["git", "diff", "--cached", "--name-only", "--diff-filter=ACMR"],
    text=True,
).splitlines()

if not staged:
    sys.exit(0)

with open(os.path.join(root, "tsconfig.json"), "r", encoding="utf-8") as fh:
    config = json.load(fh)

includes = config.get("include", ["**/*.ts", "**/*.tsx"])
excludes = config.get("exclude", [])

def matches(path: str, patterns: list[str]) -> bool:
    return any(fnmatch.fnmatch(path, pattern) for pattern in patterns)

filtered = [
    path
    for path in staged
    if matches(path, includes) and not matches(path, excludes)
]

if not filtered:
    sys.exit(0)

print("Running biome lint on staged TypeScript files...")
subprocess.run(["bun", "x", "biome", "lint", *filtered], check=True)
PY
