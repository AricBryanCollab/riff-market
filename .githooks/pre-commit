#!/usr/bin/env bash
set -euo pipefail

node <<'NODE'
const { execSync, spawnSync } = require("node:child_process");
const path = require("node:path");
const ts = require("typescript");

const root = execSync("git rev-parse --show-toplevel", { encoding: "utf8" }).trim();
const staged = execSync("git diff --cached --name-only --diff-filter=ACMR", { encoding: "utf8" })
	.split("\n")
	.filter(Boolean);

if (staged.length === 0) {
	process.exit(0);
}

const configPath = path.join(root, "tsconfig.json");
const configFile = ts.readConfigFile(configPath, ts.sys.readFile);
if (configFile.error) {
	const formatHost = {
		getCurrentDirectory: ts.sys.getCurrentDirectory,
		getCanonicalFileName: (file) => file,
		getNewLine: () => ts.sys.newLine,
	};
	console.error(ts.formatDiagnosticsWithColorAndContext([configFile.error], formatHost));
	process.exit(1);
}

const parsed = ts.parseJsonConfigFileContent(configFile.config, ts.sys, root);
const included = new Set(
	parsed.fileNames.map((file) =>
		path.relative(root, file).split(path.sep).join("/"),
	),
);

const filtered = staged.filter((file) => included.has(file));
if (filtered.length === 0) {
	process.exit(0);
}

console.log("Running biome lint on staged TypeScript files...");
const result = spawnSync("bun", ["x", "biome", "lint", ...filtered], {
	cwd: root,
	stdio: "inherit",
});
process.exit(result.status ?? 0);
NODE
